#!/usr/bin/env bash

# All paths are relative to the root of the project
# to run from a script in `package.json`
# `pnpm oas:update`
ENV_FILE=".env"
OUT_DIRNAME="tmdb-oas"
OUT_FILENAME="tmdb.oas.json"
TMDB_OAS_ENV_KEY="TMDB_OAS_URL"

ENV_FILE_CONTENT="$(grep -e '^[^#].*$' "$ENV_FILE")"
TMDB_OAS_ENV_LINE="$(echo "$ENV_FILE_CONTENT" | grep "$TMDB_OAS_ENV_KEY")"

PATTERN='*="'
REPLACE_STR="" # not needed but better to be explicit...

TMDB_OAS_ENV_PLUS_QUOTE=${TMDB_OAS_ENV_LINE/${PATTERN}/${REPLACE_STR}}
TMDB_OAS_ENV_VALUE="${TMDB_OAS_ENV_PLUS_QUOTE:0:(${#TMDB_OAS_ENV_PLUS_QUOTE} - 1)}"
printf "%s" "${TMDB_OAS_ENV_VALUE}"

### `zsh` version
# TMDB_OAS_ENV_PLUS_QUOTE=${TMDB_OAS_ENV_LINE//${~PATTERN}/${REPLACE_STR}}
# TMDB_OAS_ENV_VALUE="${TMDB_OAS_ENV_PLUS_QUOTE:0:(${#TMDB_OAS_ENV_PLUS_QUOTE} - 1)}"
# printf "%s" "${TMDB_OAS_ENV_VALUE}"

### Using `sed`
# shellcheck disable=SC2001
# printf "%s" "$TMDB_OAS_ENV_LINE" | sed -e "s/^.*=\"\(.*\)\"$/\1/"

curl "$TMDB_OAS_ENV_VALUE" | jq > "$OUT_DIRNAME/$OUT_FILENAME"
